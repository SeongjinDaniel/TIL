# 스프링 프레임워크 핵심 기술

스프링 프레임워크(이하 스프링) 5.1 버전이 출시 되었습니다. 버전이 올라갈 수록 스프링은 다양한 프로그래밍 기법과 기능을 제공하지만 스프링의 핵심 기술은 크게 변하지 않았습니다.

즉, IoC 컨테이너, AOP 그리고 몇몇 핵심 API는 스프링을 탄탄하게 지탱하는 디딤돌과 같습니다. 따라서 스프링 핵심 기술을 이해한다면, 스프링이 제공하는 JDBC, 테스트, MVC 관련 기능 뿐 아니라, 스프링 부트와 스프링 데이터 JPA와 같은 여러 다른 스프링 프로젝트도 빠르고 정확히 이해할 수 있습니다.

구체적으로 이번 강좌에서는 스프링 IOC(Inversion Of Control) 컨테이너와 빈 그리고 스프링 AOP(Aspect Oriented Programming)에 대해 자세히 학습합니다. 또한, 스프링이 제공하는 여러 기능의 기반이 되는 Resource, Validation, 데이터 바인딩과 같은 스프링의 여러 추상 API와 Null 관련 유틸리티도 학습합니다.

이번 강좌는 IoC, AOP, PSA에 대해 들어는 봤지만, 실제 스프링으로 코딩을 해본적이 없는 분들 또는 핵심 기술에 대한 이해 없이 MVC로 웹 애플리케이션 개발만 해온 개발자 또는 학생을 대상으로 합니다. 따라서 소개와 이해를 중심으로 설명하기 때문에 매우 깊이있게 다루진 않습니다. 심화 학습을 하고 싶으신 분들께는 이번 강좌를 추천하지 않습니다.

이번 강좌는 스프링 부트를 사용하여 스프링 핵심 기술을 학습합니다. 따라서 스프링 부트 기반의 프로젝트를 사용하고 있는 개발자 또는 학생에게 유용한 스프링 강좌입니다. 스프링 부트가 제공하는 여러 기능이 스프링의 핵심기술과 어떻게 관련이 있는지 이해할 수 있습니다.

## 학습목표

- 스프링 프레임워크의 핵심 기술 Ioc, AOP, PSA를 이해합니다..
- 스프링 프레임워크 IoC 컨테이너의 다양한 기능을 사용할 수 있습니다.
- 다양한 방법으로 빈을 정의하고 의존 관계를 주입할 수 있습니다.
- 스프링 AOP를 사용하여 Aspect를 모듈화 할 수 있습니다.
- 그밖에 다양한 스프링 핵심 기술을 이해하고 또 활용할 수 있습니다.

## 학습 목차

- IoC 컨테이너와 빈
- 리소스
- Validation
- 데이터 바인딩
- SpEL
- 스프링 AOP
- Null-Safety



## 1. 강좌 및 스프링 소개

**참고: 스프링 프레임워크 레퍼런스**

https://docs.spring.io/spring/docs/current/spring-framework-reference/index.html



**스프링이란?**

https://docs.spring.io/spring/docs/current/spring-framework-reference/overview.html#overview

**"소규모 애플리케이션 또는 기업용 애플리케이션을 자바로 개발하는데 있어 유용하고 편리한 기능을 제공하는 프레임워크"**

- 스프링 프레임워크 그 자체
- 스프링 프레임워크 포함 모든 스프링 프로젝트 (스프링 부트, 스프링 데이터, 스프링 시큐리티...)
- 이 강좌에서 스프링은 "스프링 프레임워크"

**스프링의 역사**

- 2003년 등장 (개발은 이미 그 이전부터 진행됐고)
  - 등장시 Java EE 표준과 싸우는 것처럼 보였지만 실제론 JEE 스팩 구현 모음체(+알파).
  - Servlet, WebSocket, Bean Validation, JPA, Dependency Injection, ...
- 최근까지 주로 서블릿 기반 애플리케이션을 만들 때 사용해 옴.
- 스프링 5부터는 WebFlux 지원으로 서블릿 기반이 아닌 서버 애플리케이션도 개발할 수 있게 됨.

**디자인 철학**

- 모든 선택은 개발자의 몫. (예, 스프링이 특정 영속화 기술을 강요하지 않는다.)
- 다양한 관점을 지향한다. (유연성)
- 하위 호환성을 지킨다. (노력)
- API를 신중하게 설계 한다. (공들인다.)
- 높은 수준의 코드를 지향한다. (자랑)



## 2. 강사 소개

백기선

- 현재 마이크로소프트에서 개발자로 재직 중
- 아마존과 네이버에서 개발자로 일한적 있음
- [Youtube/백기선 채널]([https://www.youtube.com/c/%EB%B0%B1%EA%B8%B0%EC%84%A0](https://www.youtube.com/c/백기선)) 운영 중
- 온라인 강좌 운영 중
  - 스프링 프레임워크 입문
  - [스프링 부트 개념과 활용]([https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8/](https://www.inflearn.com/course/스프링부트/))
  - [스프링 데이터 JPA]([https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa/](https://www.inflearn.com/course/스프링-데이터-jpa/))

## 3. IoC 컨테이너 1부: 스프링 IoC 컨테이너와 빈

Inversion of Control: 의존 관계 주입DI(Dependency Injection)이라고도 하며, 어떤 객체가
사용하는 의존 객체를 직접 만들어 사용하는게 아니라, 주입 받아 사용하는 방법 을 말 함.
**스프링 IoC 컨테이너**

- [ BeanFactory](https://docs.spring.io/spring-framework/docs/5.0.8.RELEASE/javadoc-api/org/springframework/beans/factory/BeanFactory.html)
-  애플리케이션 컴포넌트의 중앙 저장소.
-  빈 설정 소스 로 부터 빈 정의 를 읽어들이고, 빈을 구성하고 제공 한다.

**빈**

-  스프링 IoC 컨테이너가 관리 하는 객체.(Bean들을 컨테이너에서 가져와서 사용할 수 있다.)

-  장점

  - 의존성 관리

  -  스코프
    -  싱글톤: 하나 (메모리면에서 장점, 런타임시 성능최적화에서 장점)
    -  프로포토타입: 매번 다른 객체
  - 라이프사이클 인터페이스

[ApplicationContext](https://docs.spring.io/spring-framework/docs/5.0.8.RELEASE/javadoc-api/org/springframework/context/ApplicationContext.html)

- BeanFactory를 상속받음
- 메시지 소스 처리 기능 (i18n)
- 이벤트 발행 기능
- 리소스 로딩 기능
- ...

## 4. IoC 컨테이너 2부: ApplicationContext와 다양한 빈 설정 방법

![image](https://user-images.githubusercontent.com/55625864/84356133-ba11e800-abfe-11ea-95fb-529ad2b7827c.png)
**스프링 IoC 컨테이너의 역할**

- 빈 인스턴스 생성
-  의존 관계 설정
- 빈 제공

**AppcliationContext**

- ClassPathXmlApplicationContext (XML)
- AnnotationConfigApplicationContext (Java)

**빈 설정**

- 빈 명세서

- 빈에 대한 정의를 담고 있다.

  - 이름
  - 클래스
  - 스코프
  - 생성자 아규먼트 (constructor)
  - 프로퍼트 (setter)
  - ..

  **컴포넌트 스캔**

  - 설정 방법
    - XML 설정에서는 context:component-scan
    - 자바 설정에서 @ComponentScan
  - 특정 패키지 이하의 모든 클래스 중에 @Component 애노테이션을 사용한 클래스를
    빈으로 자동으로 등록 해 줌.



## 5 . IoC 컨테이너 3부: @Autowire

필요한 의존 객체의 “타입"에 해당하는 빈을 찾아 주입한다.
**@Autowired**

-  required: 기본값은 true (따라서 못 찾으면 애플리케이션 구동 실패)

**사용할 수 있는 위치**

- 생성자 (스프링 4.3 부터는 생략 가능)
- 세터
- 필드

**경우의 수**

- 해당 타입의 빈이 없는 경우
- 해당 타입의 빈이 한 개인 경우
- 해당 타입의 빈이 여러 개인 경우
  - 빈 이름으로 시도,
    - 같은 이름의 빈 찾으면 해당 빈 사용
    - 같은 이름 못 찾으면 실패

**같은 타입의 빈이 여러개 일 때**

- @Primary --> 추천!!
- 해당 타입의 빈 모두 주입 받기
- @Qualifier (빈 이름으로 주입) --> 개인적으로는 @Primary로 쓰는게 좋을듯!

**동작 원리**

- 첫시간에 잠깐 언급했던 빈 라이프사이클 기억하세요?
- [BeanPostProcessor](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/config/BeanPostProcessor.html)
  - 새로 만든 빈 인스턴스를 수정할 수 있는 라이프 사이클 인터페이스
- [AutowiredAnnotationBeanPostProcessor](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/annotation/AutowiredAnnotationBeanPostProcessor.html) extends BeanPostProcessor
  - 스프링이 제공하는 @Autowired와 @Value 애노테이션 그리고 JSR-330의
    @Inject 애노테이션을 지원하는 애노테이션 처리기.

**PostConstruct**

- 빈이 다 생성 된 후  주입.



# 6. IoC 컨테이너 4부: @Component와 컴포넌트 스캔

**컨포넌트 스캔 주요 기능**

-  스캔 위치 설정 -> @SpringBootApplication은 package안에 하위 내용들은 모두 스캔함
- 필터: 어떤 애노테이션을 스캔 할지 또는 하지 않을지



**@Component**

- @Repository
- @Service
- @Controller
- @Configuration

**동작 원리**

- @ComponentScan은 스캔할 패키지와 애노테이션에 대한 정보
- 실제 스캐닝은 ConfigurationClassPostProcessor 라는 BeanFactoryPostProcessor 에
  의해 처리 됨.

**펑션을 사용한 빈 등록**

```java
public static void main(String[] args) {
    new SpringApplicationBuilder()
    .sources(Demospring51Application.class)
    .initializers((ApplicationContextInitializer<GenericApplicationContext>)
    applicationContext -> {
    	applicationContext.registerBean(MyBean.class);
    })
    .run(args);
}
```



# 7. IoC 컨테이너 5부: 빈의 스코프
**스코프**

- 싱글톤
- 프로토타입
  -  Request
  - Session
  - WebSocket
  - ...

**프로토타입 빈이 싱글톤 빈을 참조하면?**

- 아무 문제 없음.

**싱글톤 빈이 프로토타입 빈을 참조하면?**

- 프로토타입 빈이 업데이트가 안되네?
- 업데이트 하려면
  - scoped-proxy
  - Object-Provider
  - Provider (표준)

**프록시**

( https://en.wikipedia.org/wiki/Proxy_pattern )

![image](https://user-images.githubusercontent.com/55625864/84560404-a7262180-ad7e-11ea-9ca9-8b28f8dd7027.png)

**싱글톤 객체 사용시 주의할 점**

- 프로퍼티가 공유.
- ApplicationContext 초기 구동시 인스턴스 생성.





# 8. IoC 컨테이너 6부: Environment 1부. 프로파일
프로파일과 프로퍼티를 다루는 인터페이스.

ApplicationContext extends [EnvironmentCapable](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/env/EnvironmentCapable.html)

- getEnvironment()

**프로파일**

- 빈들의 그룹
- [Environment](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/env/Environment.html) 의 역할은 활성화할 프로파일 확인 및 설정

**프로파일 유즈케이스**

- 테스트 환경에서는 A라는 빈을 사용하고, 배포 환경에서는 B라는 빈을 쓰고 싶다.
- 이 빈은 모니터링 용도니까 테스트할 때는 필요가 없고 배포할 때만 등록이 되면
  좋겠다.

**프로파일 정의하기**

- 클래스에 정의
  - @Configuration @Profile(“test”)
  - @Component @Profile(“test”)
- 메소드에 정의
  - @Bean @Profile(“test”)

**프로파일 설정하기**

- -Dspring.profiles.avtive=”test,A,B,...”
- [@ActiveProfiles](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/context/ActiveProfiles.html) (테스트용)

**프로파일 표현식**

- ! (not)
- & (and)
- | (or)



# 9. IoC 컨테이너 6부: Environment 2부. 프로퍼티
**프로퍼티**

- 다양한 방법으로 정의할 수 있는 설정값
- [Environment](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/env/Environment.html) 의 역할은 프로퍼티 소스 설정 및 프로퍼티 값 가져오기

**프로퍼티에는 우선 순위가 있다.**

- StandardServletEnvironment의 우선순위

  - ServletConfig 매개변수
  - ServletContext 매개변수
  - JNDI (java:comp/env/)
  - JVM 시스템 프로퍼티 (-Dkey=”value”)
  - JVM 시스템 환경 변수 (운영 체제 환경 변수)

  @PropertySource

  - Environment를 통해 프로퍼티 추가하는 방법

  스프링 부트의 외부 설정 참고

  - 기본 프로퍼티 소스 지원 (application.properties)
  - 프로파일까지 고려한 계층형 프로퍼티 우선 순위 제공

