# 20200421 R Study (R & Java 연동)



[ Java와 R 연동 테스트용 프로젝트 생성 ]
(1) redu 라는 Spring MVC Project 을 생성한다.
    중간에 입력하는 top-level 패키지명 : edu.spring.redu
(2) pom.xml 에서 3페이지에 있는 <dependency> 태그 추가하기
     Rserve 를 사용하기 위해 API 설치를 위해서 하는 거임
(3) pom.xml 에서 Java 버전과 Spring 버전 정보 수정하기
     project facet 도 수정한다. Java 1.8 로....
(4) Query 문자열 추출시 한글 문제가 해결되도록 환경 설정 추가하기
     --> web.xml에 한글처리 필터 클래스 등록
(5) 소스 내용을 검토하고 servlet-context.xml 에 
     component-scan 태그를 추가한다.
	<context:component-scan base-package="rtest" />	
	<context:component-scan base-package="service" />

------

[ Rserve 기동 ] (1) RStudio 에서 기동시키기

 Rserve(args="--RS-encoding utf8") 

(2) CMD 창에서 단독으로 기동시키기(단독 기동 가능, 오류 메시지 확인 장점) C:\Users\student\Documents\R\win-library\3.6\Rserve\libs\x64(윈도우10) 

C:\Program Files\R\R-3.6.1\library\Rserve\libs\x64(윈도우7)의 모든 파일을 

C:\Program Files\R\R-xxxx\bin\x64 디렉토리에 복사한 후에

cmd 창을 띄우고 C:\Program Files\R\R-xxxx\bin\x64 

디렉토리에 가서 다음 명령을 수행시킨다. 

`C:\Program Files\R\R-3.6.3\bin\x64` -> 내 컴퓨터 route

**Rserve --RS-encoding utf8**



--> R Server 기동 완료!!! 

-----------

pom_xml파일에추가

```xml
<dependency>
			<groupId>com.github.lucarosellini.rJava</groupId>
			<artifactId>JRIEngine</artifactId>
			<version>0.9-7</version>
		</dependency>
		<dependency>
			<groupId>net.rforge</groupId>
			<artifactId>Rserve</artifactId>
			<version>0.6-8.1</version>
		</dependency>
```

#### RServeExmple.java

Java Resouces -> rjavaapp 패키지 추가

```java
package rjavaapp;

import org.rosuda.REngine.REXP;
import org.rosuda.REngine.REXPMismatchException;
import org.rosuda.REngine.REngineException;
import org.rosuda.REngine.RList;
import org.rosuda.REngine.Rserve.RConnection;
import org.rosuda.REngine.Rserve.RserveException;

public class RServeExample {
	public static void getString() throws RserveException, REXPMismatchException {
		RConnection rc = new RConnection();
		String s = "가나다";
		// java의 특정 변수 값을 r에 대입
		// 첫번째 아규먼트 : r 변수를 준다. , 두번째 아규먼트 x변수에 s를 대입(할당할 값)
		rc.assign("x", s);
		// y라는 객체를 새로 만들면서 s값을 넣어준다. // 위 rc.assign과 같다.
		rc.eval("y<- '" + s + "'");
		rc.eval("if(x == '가나다') print('XXX')");
		rc.eval("if(y == '가나다') print('YYY')");
		// assign쓸때는 이방법을 사용
		rc.eval("Encoding(x)<- 'UTF-8'");
		// eval에서 대입해서 쓸때는 이방법을 사용
		rc.eval("y<-iconv(y, 'CP949', 'UTF-8')");
		//rc.eval 안에 있는 것들은 R code이다.
		// R.version.string : string에 version 정보를 가지고 있다. R version 정보를 가지고있다.
		// java에서 r의 값들을 가져올때는 REXP변수를 사용해야한다.
		REXP x = rc.eval("paste(R.version.string,x,y)");
		// x 변수를 String으로 사용할때는 as.String을 사용하면 된다.
		System.out.println("R 버전 정보 : " + x.asString());
		rc.close();
	}

	public static void getInteger() throws RserveException, REXPMismatchException {
		RConnection rc = new RConnection();
		REXP x = rc.eval("length(LETTERS)");
		System.out.println("알파벳 갯수 : " + x.asInteger());
		rc.close();
	}

	public static void getDoubles() throws RserveException, REXPMismatchException {
		RConnection rc = new RConnection();
		REXP x = rc.eval("rnorm(20)");
		double[] d = x.asDoubles();
		for (int i = 0; i < d.length; i++) {
			System.out.println(d[i]);
		}
		rc.close();
	}

	public static void getIntegers() throws REngineException, REXPMismatchException {
		RConnection rc = new RConnection();
		int[] dataX = { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };
		rc.assign("x", dataX);
		rc.eval("y <- x + 10");
		int[] resultX = rc.eval("y").asIntegers();
		for (int i = 0; i < resultX.length; i++) {
			System.out.println(resultX[i]);
		}
		rc.close();
	}

	public static void getDataFrame1() throws RserveException, REXPMismatchException {
		RConnection rc = new RConnection();
		REXP x = rc.eval("d<-data.frame(LETTERS[11:20],c(11:20), stringsAsFactors=F)");
		RList list = x.asList();
		int v_size = list.size();
		int d_length = list.at(0).length();
		System.out.println("데이터(관측치)의 갯수 : " + d_length);
		System.out.println("변수의 갯수 : " + v_size);

		int arrayRows = v_size;
		int arrayCols = d_length;
		String[][] s = new String[arrayRows][]; // 데이터프레임의 변수 갯수로 행의 크기를 정한다.

		for (int i = 0; i < arrayRows; i++) {
			s[i] = list.at(i).asStrings();
		}

		for (int i = 0; i < arrayRows; i++) {
			for (int j = 0; j < arrayCols; j++) {
				System.out.print(s[i][j] + "\t");
			}
			System.out.println();
		}
		rc.close();
	}

	public static void getDataFrame2() throws RserveException, REXPMismatchException {
		RConnection rc = new RConnection();
		REXP x = rc.eval("imsi<-source('C:/Oliver/Rstudy/rjavatest.R'); imsi$value");
		RList list = x.asList();

		String pid = list.at("product").asString();
		System.out.print("PID : " + pid);

		int clickcount = list.at("clickcount").asInteger();
		System.out.println("\tCLICKCOUNT : " + clickcount);
		rc.close();
	}

	public static void main(String[] args) throws REXPMismatchException, REngineException {
		System.out.println("------------ R에서 버젼정보 가져오기 --------------");
		RServeExample.getString();
		System.out.println("------------ R에서 정수 데이터 가져오기 --------------");
		RServeExample.getInteger();
		System.out.println("------------ R에서 더블 데이터들 가져오기 -------------");
		RServeExample.getDoubles();
		System.out.println("------------  R에서 데이터 주입 연산후 가져오기 ------");
		RServeExample.getIntegers();
		System.out.println("------------  R에서 데이터 생성(데이터 프레임) 연산후 가져오기------");
		RServeExample.getDataFrame1();
		System.out.println("------------ R에서 데이터 프레임 가져오기 --------------");
		RServeExample.getDataFrame2();

	}
}
```

